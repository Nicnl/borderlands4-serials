package serial_tokenizer

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestReadPart(t *testing.T) {
	tests := []struct {
		bin      string
		expected uint32
		pos      int
	}{
		// Short form
		{"00000 000", 0, 8},
		{"10000 000", 1, 8},
		{"01000 000", 2, 8},
		{"00100 000", 4, 8},
		{"00010 000", 8, 8},
		{"00000 100", 16, 8},
		{"00000 010", 32, 8},
		{"00000 001", 64, 8},

		{"11110 111", 127, 8},
		{"01110 111", 126, 8},
		{"00110 111", 124, 8},
		{"00010 111", 120, 8},
		{"00000 111", 112, 8},
		{"00000 011", 96, 8},
		{"00000 001", 64, 8},

		// Long form
		{"00001 00000000", 0, 13},
		{"10001 00000000", 1, 13},
		{"01001 00000000", 2, 13},
		{"00101 00000000", 4, 13},
		{"00011 00000000", 8, 13},
		{"00001 10000000", 16, 13},
		{"00001 01000000", 32, 13},
		{"00001 00100000", 64, 13},
		{"00001 00010000", 128, 13},
		{"00001 00001000", 256, 13},
		{"00001 00000100", 512, 13},
		{"00001 00000010", 1024, 13},

		{"11111 11111110", 2047, 13},
		{"01111 11111110", 2046, 13},
		{"00111 11111110", 2044, 13},
		{"00011 11111110", 2040, 13},
		{"00001 11111110", 2032, 13},
		{"00001 01111110", 2016, 13},
		{"00001 00111110", 1984, 13},
		{"00001 00011110", 1920, 13},
		{"00001 00001110", 1792, 13},
		{"00001 00000110", 1536, 13},
		{"00001 00000010", 1024, 13},

		{"00001 00000001 00000000000", 0, 24},
		{"10001 00000001 00000000000", 1, 24},
		{"01001 00000001 00000000000", 2, 24},
		{"00101 00000001 00000000000", 4, 24},
		{"00011 00000001 00000000000", 8, 24},
		{"00001 10000001 00000000000", 16, 24},
		{"00001 01000001 00000000000", 32, 24},
		{"00001 00100001 00000000000", 64, 24},
		{"00001 00010001 00000000000", 128, 24},
		{"00001 00001001 00000000000", 256, 24},
		{"00001 00000101 00000000000", 512, 24},
		{"00001 00000011 00000000000", 1024, 24},
		{"00001 00000001 10000000000", 2048, 24},
		{"00001 00000001 01000000000", 4096, 24},
		{"00001 00000001 00100000000", 8192, 24},
		{"00001 00000001 00010000000", 16384, 24},
		{"00001 00000001 00001000000", 32768, 24},
		{"00001 00000001 00000100000", 65536, 24},
		{"00001 00000001 00000010000", 131072, 24},
		{"00001 00000001 00000001000", 262144, 24},
		{"00001 00000001 00000000100", 524288, 24},
		{"00001 00000001 00000000010", 1048576, 24},
		//{"0000 1 00000010 00000000001", 2097152, 24},
	}

	for _, tt := range tests {
		t.Run(tt.bin, func(t *testing.T) {
			data := binToBytes(tt.bin)
			tok := NewTokenizer(data)
			val, err := tok.readPart()
			assert.NoError(t, err)
			assert.Equal(t, tt.expected, val)
			assert.Equal(t, tt.pos, tok.bs.Pos())
		})
	}
}
