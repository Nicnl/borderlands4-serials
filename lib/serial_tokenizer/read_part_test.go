package serial_tokenizer

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestReadPart(t *testing.T) {
	tests := []struct {
		bin      string
		expected uint16
		pos      int
	}{
		// Short form
		{"0000 0 000", 0, 8},
		{"1000 0 000", 1, 8},
		{"0100 0 000", 2, 8},
		{"0010 0 000", 4, 8},
		{"0001 0 000", 8, 8},
		{"0000 0 100", 16, 8},
		{"0000 0 010", 32, 8},
		{"0000 0 001", 64, 8},

		{"1111 0 111", 127, 8},
		{"0111 0 111", 126, 8},
		{"0011 0 111", 124, 8},
		{"0001 0 111", 120, 8},
		{"0000 0 111", 112, 8},
		{"0000 0 011", 96, 8},
		{"0000 0 001", 64, 8},

		// Long form
		{"0000 1 00000000", 0, 13},
		{"1000 1 00000000", 1, 13},
		{"0100 1 00000000", 2, 13},
		{"0010 1 00000000", 4, 13},
		{"0001 1 00000000", 8, 13},
		{"0000 1 10000000", 16, 13},
		{"0000 1 01000000", 32, 13},
		{"0000 1 00100000", 64, 13},
		{"0000 1 00010000", 128, 13},
		{"0000 1 00001000", 256, 13},
		{"0000 1 00000100", 512, 13},
		{"0000 1 00000010", 1024, 13},
		{"0000 1 00000001", 2048, 13},

		{"1111 1 11111111", 4095, 13},
		{"0111 1 11111111", 4094, 13},
		{"0011 1 11111111", 4092, 13},
		{"0001 1 11111111", 4088, 13},
		{"0000 1 11111111", 4080, 13},
		{"0000 1 01111111", 4064, 13},
		{"0000 1 00111111", 4032, 13},
		{"0000 1 00011111", 3968, 13},
		{"0000 1 00001111", 3840, 13},
		{"0000 1 00000111", 3584, 13},
		{"0000 1 00000011", 3072, 13},
		{"0000 1 00000001", 2048, 13},
	}

	for _, tt := range tests {
		t.Run(tt.bin, func(t *testing.T) {
			data := binToBytes(tt.bin)
			tok := NewTokenizer(data)
			val, err := tok.readPart()
			assert.NoError(t, err)
			assert.Equal(t, tt.expected, val)
			assert.Equal(t, tt.pos, tok.bs.Pos())
		})
	}
}
