package serial_tokenizer

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestReadPart(t *testing.T) {
	tests := []struct {
		bin      string
		expected uint32
		pos      int
	}{
		// Short form
		{"0000 0 000", 0, 8},
		{"1000 0 000", 1, 8},
		{"0100 0 000", 2, 8},
		{"0010 0 000", 4, 8},
		{"0001 0 000", 8, 8},
		{"0000 0 100", 16, 8},
		{"0000 0 010", 32, 8},
		{"0000 0 001", 64, 8},

		{"1111 0 111", 127, 8},
		{"0111 0 111", 126, 8},
		{"0011 0 111", 124, 8},
		{"0001 0 111", 120, 8},
		{"0000 0 111", 112, 8},
		{"0000 0 011", 96, 8},
		{"0000 0 001", 64, 8},

		// Long form
		{"0000 1 00000000", 0, 13},
		{"1000 1 00000000", 1, 13},
		{"0100 1 00000000", 2, 13},
		{"0010 1 00000000", 4, 13},
		{"0001 1 00000000", 8, 13},
		{"0000 1 10000000", 16, 13},
		{"0000 1 01000000", 32, 13},
		{"0000 1 00100000", 64, 13},
		{"0000 1 00010000", 128, 13},
		{"0000 1 00001000", 256, 13},
		{"0000 1 00000100", 512, 13},
		{"0000 1 00000010", 1024, 13},

		{"1111 1 11111110", 2047, 13},
		{"0111 1 11111110", 2046, 13},
		{"0011 1 11111110", 2044, 13},
		{"0001 1 11111110", 2040, 13},
		{"0000 1 11111110", 2032, 13},
		{"0000 1 01111110", 2016, 13},
		{"0000 1 00111110", 1984, 13},
		{"0000 1 00011110", 1920, 13},
		{"0000 1 00001110", 1792, 13},
		{"0000 1 00000110", 1536, 13},
		{"0000 1 00000010", 1024, 13},

		{"0000 1 00000001 00000000000", 0, 24},
		{"1000 1 00000001 00000000000", 1, 24},
		{"0100 1 00000001 00000000000", 2, 24},
		{"0010 1 00000001 00000000000", 4, 24},
		{"0001 1 00000001 00000000000", 8, 24},
		{"0000 1 10000001 00000000000", 16, 24},
		{"0000 1 01000001 00000000000", 32, 24},
		{"0000 1 00100001 00000000000", 64, 24},
		{"0000 1 00010001 00000000000", 128, 24},
		{"0000 1 00001001 00000000000", 256, 24},
		{"0000 1 00000101 00000000000", 512, 24},
		{"0000 1 00000011 00000000000", 1024, 24},
		{"0000 1 00000001 10000000000", 2048, 24},
		{"0000 1 00000001 01000000000", 4096, 24},
		{"0000 1 00000001 00100000000", 8192, 24},
		{"0000 1 00000001 00010000000", 16384, 24},
		{"0000 1 00000001 00001000000", 32768, 24},
		{"0000 1 00000001 00000100000", 65536, 24},
		{"0000 1 00000001 00000010000", 131072, 24},
		{"0000 1 00000001 00000001000", 262144, 24},
		{"0000 1 00000001 00000000100", 524288, 24},
		{"0000 1 00000001 00000000010", 1048576, 24},
		//{"0000 1 00000010 00000000001", 2097152, 24},
	}

	for _, tt := range tests {
		t.Run(tt.bin, func(t *testing.T) {
			data := binToBytes(tt.bin)
			tok := NewTokenizer(data)
			val, err := tok.readPart()
			assert.NoError(t, err)
			assert.Equal(t, tt.expected, val)
			assert.Equal(t, tt.pos, tok.bs.Pos())
		})
	}
}
